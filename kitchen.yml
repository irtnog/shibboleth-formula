# -*- coding: utf-8 -*-
# vim: ft=yaml
---
# For help on this file's format, see https://kitchen.ci/
driver:
  name: docker
  use_sudo: false
  privileged: true
  run_command: /lib/systemd/systemd
  provision_command: mkdir -p /run/sshd

# Make sure the platforms listed below match up with
# the `env.matrix` instances defined in `.travis.yml`
platforms:
  # Latest distros
  - name: debian-9
    driver:
      provision_command:
        - apt-get update && apt-get install -y udev
  - name: ubuntu-18.04
    driver:
      provision_command:
        - apt-get update && apt-get install -y udev
  - name: centos-7
  - name: fedora-29
    driver:
      provision_command:
        - yum -y update && yum -y install udev
  - name: opensuse-42.3
    driver:
      provision_command:
        - zypper refresh && zypper install -y udev
        - systemctl enable sshd.service
      run_command: /usr/lib/systemd/systemd

  # Previous distros
  - name: debian-8
  - name: ubuntu-16.04
    driver:
      provision_command:
        - apt-get update && apt-get install -y udev
  - name: fedora-28
    driver:
      provision_command:
        - yum -y update && yum -y install udev
  # centos-6 guest fails on Debian hosts due to vsyscall issues, see
  # https://hub.docker.com/_/centos, "A note about vsyscall"
  # Disabled for `shibboleth-formula` because not `systemd` based
  # - name: centos-6
  #   driver:
  #     run_command: /sbin/init

provisioner:
  name: salt_solo
  log_level: info
  salt_version: latest
  require_chef: false
  formula: shibboleth
  salt_copy_filter:
    - .kitchen
    - .git
  state_top:
    base:
      '*':
        - shibboleth.repo
        - shibboleth.idp
        - shibboleth.mda
        - shibboleth.sp
        - shibboleth.ds
        - xmlsectool
  pillars:
    top.sls:
      base:
        '*':
          - shibboleth
  pillars_from_files:
    shibboleth.sls: pillar.example

verifier:
  # https://www.inspec.io/
  name: inspec
  sudo: true
  # cli, documentation, html, progress, json, json-min, json-rspec, junit
  reporter:
    - cli
  inspec_tests:
    - path: test/integration/default

suites:
  # Latest distros, latest salt, python3
  # These distros have py3 packages available in salt's repo
  - name: v2019-2-py3
    includes:
      - debian-9
      - ubuntu-18.04
    provisioner:
      salt_bootstrap_options: -X -x python3 -d git %s
      salt_version: '2019.2'
      pillars:
        salt.sls:
          salt:
            release: '2019.2'
            py_ver: 'py3'
    # verifier:
    #   inspec_tests:
    #     - path: test/integration/2019-2

  # Latest distros, latest salt, python2
  # Fedora ships updated py2 versions in their own repos
  - name: v2019-2-py2
    includes:
      - centos-7
      - fedora-29
    provisioner:
      salt_version: '2019.2'
      pillars:
        salt.sls:
          salt:
            release: '2019.2'
            py_ver: 'py2'
    # verifier:
    #   inspec_tests:
    #     - path: test/integration/2019-2

  # Previous distros, previous salt, python2
  - name: v2018-3-py2
    includes:
      - debian-8
      - ubuntu-16.04
      - opensuse-42.3
    provisioner:
      # We require an old version of salt in the provisioner or,
      # the salt formula fails to downgrade to the desired version to test
      salt_version: '2018.3'
      pillars:
        salt.sls:
          salt:
            release: '2018.3'
            py_ver: 'py2'
    # verifier:
    #   inspec_tests:
    #     - path: test/integration/2018-3

  # # centos-6 ships with python2.6, so it requires extra bootstrapping parameters
  # # to install python2.7
  # - name: v2018-3-py2-bootstrap
  #   includes:
  #     - centos-6
  #   provisioner:
  #     salt_bootstrap_options: -X -d stable %s
  #     salt_version: '2018.3'
  #     pillars:
  #       salt.sls:
  #         salt:
  #           release: '2018.3'
  #           py_ver: 'py2'
  #   # verifier:
  #   #   inspec_tests:
  #   #     - path: test/integration/2018-3

  # To tests fedora 28 & salt v2018.2, we need to force the package version
  # otherwise the image, which includes the 'updates' repo, will install 2019.2
  - name: v2018-3-py2-forced-version
    includes:
      - fedora-28
    provisioner:
      # We require an old version of salt in the provisioner or,
      # the salt formula fails to downgrade to the desired version to test
      salt_version: '2018.3'
      pillars:
        salt.sls:
          salt:
            release: '2018.3'
            py_ver: 'py2'
            version: '2018.3.0-1.fc28'
    # verifier:
    #   inspec_tests:
    #     - path: test/integration/2018-3

  # Previous distros, oldest salt, python2
  - name: v2017-7-py2
    includes:
      - debian-8
      - ubuntu-16.04
    provisioner:
      # We require an old version of salt in the provisioner or,
      # the salt formula fails to downgrade to the desired version to test
      salt_version: '2017.7'
      pillars:
        salt.sls:
          salt:
            release: '2017.7'
            py_ver: 'py2'
    # verifier:
    #   inspec_tests:
    #     - path: test/integration/2017-7

  # # centos-6 ships with python2.6, so it requires extra bootstrapping parameters
  # # to install python2.7
  # - name: v2017-7-py2-bootstrap
  #   includes:
  #     - centos-6
  #   provisioner:
  #     # As centos-6 ships with python2.6, we use the bootstrapper to install python2.7
  #     salt_bootstrap_options: -X -d stable %s
  #     salt_version: '2017.7'
  #     pillars:
  #       salt.sls:
  #         salt:
  #           release: '2017.7'
  #           py_ver: 'py2'
  #   # verifier:
  #   #   inspec_tests:
  #   #     - path: test/integration/2017-7

